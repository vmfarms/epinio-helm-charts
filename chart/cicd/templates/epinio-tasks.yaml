apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: {{ .Release.Name }}-epinio-push-cicd
  labels:
    {{- range $key, $value := .Values.labels }}
    {{ $key }}: {{ $value | quote }} 
    {{- end }}
    {{- include "cicd-bind.labels" . | nindent 4 }}
spec:
  description: Read and display README file.
  workspaces:
    - name: source
  params:
    - name: app-name
      type: string
  steps:
    - computeResources: {}
      image: harbor.beta.stack.io/epinio/epinio-tekton:v1.11.0
      env:
      - name: EPINIO_PASSWORD
        valueFrom: 
          secretKeyRef:
            key: password
            name: epinio-auth
      name: epinio
      script: |
        #!/usr/bin/env sh

        capture_and_stream() {
          tmpfile=$(mktemp)
          "$@" 2>&1 | tee "$tmpfile"
          output=$(cat "$tmpfile")
          rm "$tmpfile"
        }

        epinio login {{ .Values.epinioURL }} --user admin --password $EPINIO_PASSWORD && \
        epinio target {{ .Release.Namespace }} && \
        capture_and_stream epinio push --path=$(workspaces.source.path) --name $(params.app-name)

        echo "$output" | tail -n 20 > $(results.output.path)
